#include <iostream>
#include <thread>
#include <mutex>
#include <string>
#include <atomic>

int coins = 101;
int Bob_coins = 0;
int Tom_coins = 0;
std::mutex mtx;
std::atomic<bool> bob_turn(true);  // Используем atomic для потокобезопасности

void coin_sharing(std::string name, int& thief_coins, int& companion_coins, bool is_bob) {
    while (true) {
        std::lock_guard<std::mutex> lock(mtx);

        if (coins <= 0) {
            break;
        }

        // Проверяем, чья очередь
        bool my_turn = is_bob ? bob_turn.load() : !bob_turn.load();

        if (my_turn && coins > 0) {
            if (coins == 1) {
                coins--;
                std::cout << name << " отдает последнюю монету покойнику" << std::endl;
                break;
            }

            coins--;
            thief_coins++;

            std::cout << name << " взял монету. Боб: " << Bob_coins
                << ", Том: " << Tom_coins << ", Осталось: " << coins << std::endl;

            // Переключаем очередь
            bob_turn = !bob_turn;
        }
    }
}

int main() {
    std::cout << "Начало дележа " << coins << " монет" << std::endl;
    std::cout << "=====================================" << std::endl;
    setlocale(LC_ALL, "Russian");
    // Упрощаем - передаем только флаг, кто есть кто
    std::thread bob_thread(coin_sharing, "Боб", std::ref(Bob_coins), std::ref(Tom_coins), true);
    std::thread tom_thread(coin_sharing, "Том", std::ref(Tom_coins), std::ref(Bob_coins), false);

    bob_thread.join();
    tom_thread.join();

    std::cout << "\n=====================================" << std::endl;
    std::cout << "Итог дележа:" << std::endl;
    std::cout << "У Боба: " << Bob_coins << " монет" << std::endl;
    std::cout << "У Тома: " << Tom_coins << " монет" << std::endl;
    std::cout << "Покойнику: " << (101 - Bob_coins - Tom_coins) << " монет" << std::endl;
    std::cout << "Всего монет: " << (Bob_coins + Tom_coins + (101 - Bob_coins - Tom_coins)) << std::endl;

    return 0;
}
